<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <input type="file" id="file" accept=".mp4">
  <script>
    const file = document.getElementById('file');

    const chunksFun = (file, size = 1024 * 1024 * 4) => {
      const chunks = []
      for (let i = 0; i < file.size; i += size) {
        chunks.push(file.slice(i, i + size))
      }
      return chunks
    }

    const uploadFiles = (chunks) => {
      // 1.批量上传，promise.all([api1,...])
      // 2.formData 方式去上传 file 标识 hash | index
      const list = []
      for (let i = 0; i < chunks.length; i++) {
        const formData = new FormData();
        formData.append('index', i)
        formData.append('filename', 'xiezhen')
        formData.append('file', chunks[i]) //写在后面
        list.push(fetch('http://localhost:3000/upload', {
          method: 'POST',
          body: formData
        }))
      }
      Promise.all(list).then(res => {
        console.log('上传成功')
        fetch('http://localhost:3000/merge',{
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            filename: 'xiezhen'
          })
        })
      })
    }

    file.addEventListener('change', (e) => {
      /** 
       * file对象原型继承blob，可以通过blob的slice方法进行切片
      */
      const file = e.target.files[0]; //file对象
      const chunks = chunksFun(file);
      uploadFiles(chunks)

    })

    /**
     * live-server启动html，在上传文件会导致重新刷新整个页面（阻止默认事件，冒泡也都无效）
     * 因为live-server默认监听当前目录下的所有文件，导致服务重启
     * 使用http-server
     * 
    */
  </script>
</body>

</html>